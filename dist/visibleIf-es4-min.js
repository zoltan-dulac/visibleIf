"use strict";var visibleIf=new function(){function removeDisabledNodes(){for(var e=0;e<visibleIfNodes.length;e++)for(var a,b=visibleIfNodes[e],c=getAllFormElementsIn(b),d=0;d<c.length;d++)a=c[d],a.disabled=!1}function refreshPageEvent(){me.refreshPage()}function setMandatoryStates(){changedInput=this;for(var a=0;a<mandatoryNodes.length;a++)setMandatoryState(mandatoryNodes[a])}function getRule(a,b){var c=a.getAttribute("data-"+b);return c||(c=a.getElementsByClassName(b),c=0==c.length?null:c[0].innerHTML.trim()),c&&(c=StringHelpers.unentify(" "+c.replace(operatorRe," $1 ")+" ")),c}function setEvents(){visibleIfNodes=document.getElementsByClassName("visibleIf"),mandatoryNodes=document.getElementsByClassName("mandatoryIf");for(var a=[visibleIfNodes,mandatoryNodes],b=document.getElementsByTagName("form"),c=0;c<b.length;c++)b[c].addEventListener("submit",formSubmitEvent);for(var d,e=0;e<a.length;e++){d=a[e];for(var s=0;s<d.length;s++){var f,g,h=d[s],l=DOMHelpers.getAncestorByTagName(h,"form");if(g=0==e?"visibleIf-rule":"mandatoryIf-rule",f=getRule(h,g),!f)throw"There is no rule for with the node with the following HTML:"+h.outerHTML;var m=getInputVars(f);if(m)for(var o,p=0;p<m.length;p++)if(o=m[p],(!nodesWithEventsAttached[l.id]||!nodesWithEventsAttached[l.id][o])&&(nodesWithEventsAttached[l.id]||(nodesWithEventsAttached[l.id]=[]),nodesWithEventsAttached[l.id][o]=!0,0<m.length)){var q=l[m[p]];if(null!=q){if("SELECT"!=q.nodeName&&q.length)for(var r=0;r<q.length;r++)q[r].addEventListener("click",refreshPageEvent);else q.addEventListener("change",refreshPageEvent);"text"==q.type&&q.addEventListener("change",refreshPageEvent),"checkbox"==q.type&&q.addEventListener("click",refreshPageEvent)}}}}}function updateVisibilityProperties(a){for(var b=a.elements,c=0;c<b.length;c++){var d=b[c],e=d.classList;isVisible(d)||e.contains("visibleIf-submitIfInvisible")?(e.remove("visibleIf-notSubmitted"),d.disabled=!1):(e.add("visibleIf-notSubmitted"),d.disabled=!0)}}function formSubmitEvent(){this.classList.contains("visibleIf-submitInvisibleData")||updateVisibilityProperties(this)}function isVisible(a){return 0!=a.offsetWidth}function setVisibility(a,b){var c=getRule(a,"visibleIf-rule"),d=a.classList;if(null==c)throw"There is no rule for with the node with the following HTML:"+a.outerHTML;var e=evaluateRule(DOMHelpers.getAncestorByTagName(a,"form"),c);e?(d.add("visibleIf-visible"),setFormElementsInside(a,!1,b)):(d.remove("visibleIf-visible"),b&&b.isPageLoad?setFormElementsInside(a,!1,b):setFormElementsInside(a,!0,b))}function setMandatoryState(a){var b=getRule(a,"mandatoryIf-rule"),c=a.classList;if(null==b)throw"There is no rule for with the node with the following HTML:"+a.outerHTML;var d=evaluateRule(DOMHelpers.getAncestorByTagName(a,"form"),getRule(a,b));d?c.add("mandatoryIf-mandatory"):c.remove("mandatoryIf-mandatory")}function evaluateRule(parentForm,rule){if(""==rule)return!0;if(null!=rule){if(!parentForm)throw"Error: the rule "+rule+" is not attached to a form.";var stringToEval,diddledRule=rule.replace(quotedStringRe,"_pLaCeHoLdEr_"),quotedVals=rule.match(quotedStringRe),formId=parentForm.id;if(formId||(formId="visibleIf-form"+nameCounter,parentForm.id=formId,nameCounter++),stringToEval=diddledRule.replace(leftBkRe,"( ").replace(rightBkRe," )").replace(varRe,"getFieldValue(document.getElementById(\""+formId+"\")[\"$1\"]) ").replace(reRe,".match(/$1/)"),quotedVals)for(var i=0;i<quotedVals.length;i++)stringToEval=stringToEval.replace(placeHolderRe,quotedVals[i]);try{return!!eval(stringToEval)}catch(a){return!1}}}function setFormElementsInside(a,b,c){c||(c={});for(var d=getAllFormElementsIn(a),e=0;e<d.length;e++){var f=d[e],g=f.classList;if(f!=changedInput)switch(f.nodeName){case"INPUT":switch(f.type){case"checkbox":f.checked&&(b?!g.contains("visibleIf-doNotReset")&&(formCache.setValue(f.name,f.value),f.checked=!1,addToInputToClear(f)):formCache.getValue(f.name)==f.value);break;case"radio":b?!g.contains("visibleIf-doNotReset")&&(f.checked&&(formCache.setValue(f.name,f.value),f.checked=!1),addToInputToClear(f)):formCache.getValue(f.name)==f.value;break;case"file":break;case"hidden":break;default:if(b){if(g.contains("fileList_fileDisplay")){g.remove("fileList_fileDisplay"),f.disabled=!1,f.name=f.name.replace("_ignore","");var h=f.outerHTML.replace(/text/,"file");f.parentNode.innerHTML=h;var j=config.getScriptedValue("visibleIf.urls.deleteFiles",{files:StringHelpers.urlencode(f.value),formProperty:f.name});req=XMLHelpers.getXMLHttpRequest(j,deleteRequestHandler)}formCache.setValue(f.name,f.value),c.isPageLoad?(f.value=f.getAttribute("value"),"null"==f.value&&(f.value="")):!g.contains("visibleIf-doNotReset")&&(f.value="",addToInputToClear(f))}else;}break;case"TEXTAREA":b&&(formCache.setValue(f.name,f.value),c.isPageLoad||!g.contains("visibleIf-doNotReset")&&(f.value="",addToInputToClear(f)));break;case"SELECT":b?(!g.contains("visibleIf-doNotReset")&&(formCache.setValue(f.name,f.selectedIndex),f.selectedIndex=0,addToInputToClear(f)),f.disabled=!0):f.disabled=!1;}}}function addToInputToClear(a){inputsToClear[a.name]||(inputsToClear[a.name]=a)}function deleteRequestHandler(){if(req&&req.readyState==ReadyState.COMPLETED)if(req.status==HttpCode.OK||req.status==HttpCode.LOCAL_OK);else throw"Something bad happened.  HTTP Status: "+req.status}function getInputVars(a){a=a.replace(leftBkRe,"( ").replace(rightBkRe," )");var b=a.match(varRe);if(null==b)return[];for(var c=0;c<b.length;c++)b[c]=b[c].trim();return b}function getAllFormElementsIn(a){a||(a=document);var b=[],c={inputs:a.getElementsByTagName("input"),selects:a.getElementsByTagName("select"),textareas:a.getElementsByTagName("textarea")};for(var d in c)for(var e=c[d],f=0;f<e.length;f++)b.push(e[f]);return b}function StringBuffer(){var a=this,b=[];a.append=function(c){return b.push(c),a},a.appendBuffer=function(a){b=b.concat(a)},a.toString=function(){return b.join("")},a.getLength=function(){return b.length},a.flush=function(){b.length=0}}var visibleIfNodes,mandatoryNodes,inputsToClear,StringHelpers,XMLHelpers,DOMHelpers,me=this,changedInput=null,varRe=/\s([a-zA-Z][a-zA-Z0-9.]*)\s/g,operatorRe=/\s*(~|!=|==|>={0,1}|<={0,1})\s*/g,leftBkRe=/\(/g,rightBkRe=/\)/g,reRe=/~ "([^"]*)"/g,quotedStringRe=/"[^"]*"/g,placeHolderString="_pLaCeHoLdEr_",placeHolderRe=new RegExp(placeHolderString),nodesWithEventsAttached=[],req=null,nameCounter=0;me.init=function(){visibleIfNodes=document.getElementsByClassName("visibleIf"),mandatoryNodes=document.getElementsByClassName("mandatoryIf"),removeDisabledNodes(),me.refreshPage({isPageLoad:!0}),setMandatoryStates(),setEvents()},me.refreshPage=function(a){var b=new StringBuffer;changedInput=this,inputsToClear=[];for(var g=0;g<visibleIfNodes.length;g++)setVisibility(visibleIfNodes[g],a);if(!a||a.isPageLoaded){for(var h in inputsToClear)0!=h&&b.append("&"),b.append(h).append("=");var c=b.toString();if(0<b.getLength()){var d=document.body.getAttribute("data-visibleif-deletedataurl");d&&(req=XMLHelpers.getXMLHttpRequest(d,deleteRequestHandler,"GET",c))}for(var i=0;i<mandatoryNodes.length;i++)setMandatoryStates(mandatoryNodes[i],a)}for(var e=document.getElementsByTagName("form"),f=0;f<e.length;f++)updateVisibilityProperties(e[f])},DOMHelpers=window.DOMHelpers?window.DOMHelpers:new function(){var a=this;a.getAncestorByTagName=function(a,b){for(var c=a.parentNode;"body"!=c.nodeName.toLowerCase();c=c.parentNode)if(b.toLowerCase()==c.nodeName.toLowerCase())return c;return null}},StringHelpers=window.StringHelpers?window.StringHelpers:new function(){var a=this;a.initWhitespaceRe=/^\s\s*/,a.endWhitespaceRe=/\s\s*$/,a.whitespaceRe=/\s/,a.unentify=function(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")},a.urlencode=function(a){return escape(a).replace("+","%2B").replace("%20","+").replace("*","%2A").replace("/","%2F").replace("@","%40")}},XMLHelpers=window.XMLHelpers?window.XMLHelpers:new function(){var a=this;a.getXMLHttpRequest=function(b,c){var d,e=a.getXMLHttpRequest.arguments,f=a.getXMLHttpRequest.arguments.length,g=2<f?e[2]:"GET",h=3<f?e[3]:"",i=!(4<f)||e[4];if(window.XMLHttpRequest)d=new XMLHttpRequest;else return null;return i&&(d.onreadystatechange=c),"GET"==g&&""!=h&&(b+="?"+h),d.open(g,b,i),d.setRequestHeader("If-Modified-Since","Sat, 1 Jan 2000 00:00:00 GMT"),d.send(h),d}}},formCache=new function(){var a=this,b=[];a.setValue=function(a,c){b[a]=c},a.getValue=function(a){return null==b[a]?"":b[a]}};visibleIf.init();
